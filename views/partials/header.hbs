<header class="site-header" role="banner">
  <div class="container header-inner">
    <a class="brand" href="/">{{@root.siteName}}{{#unless @root.siteName}}DayOff{{/unless}}</a>

    <button id="nav-toggle" class="nav-toggle" aria-controls="nav-list" aria-expanded="false" aria-label="Toggle navigation">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/></svg>
    </button>

    <nav id="nav-list" class="site-nav" role="navigation" aria-label="Primary">
      <ul>
        {{#if session.user}}
          {{#if (and (ne session.user.role "employee") (ne (lowercase session.user.name) "yousef"))}}
            <li><a href="/dashboard">Dashboard</a></li>
          {{/if}}
          <li><a href="/requests">Requests</a></li>
          {{#if (and (ne session.user.role "employee") (ne (lowercase session.user.name) "yousef"))}}
            <li class="settings-dropdown">
              <button class="settings-btn" id="settings-btn" aria-label="Settings menu" aria-haspopup="true" aria-expanded="false">
                Settings
                <svg class="chev" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
              </button>
              <ul class="settings-menu" id="settings-menu" role="menu" aria-label="Settings">
                <li role="none"><a role="menuitem" href="/users">Users Settings</a></li>
                <li role="none"><a role="menuitem" href="/departments">Department Settings</a></li>
                <li role="none"><a role="menuitem" href="/sections">Section Settings</a></li>
              </ul>
            </li>
            <li><a href="/requests/archive">Archive</a></li>
          {{/if}}
        {{/if}}
      </ul>

      <div class="nav-right">
        {{#if session.user}}
          <div class="profile" tabindex="0" aria-haspopup="true" aria-expanded="false">
            <button class="profile-btn" id="profile-btn" aria-label="Open profile menu">
              <span class="avatar" aria-hidden="true">{{#if session.user.avatar}}<img src="{{session.user.avatar}}" alt="{{session.user.name}}"/>{{else}}{{session.user.name.[0]}}{{/if}}</span>
              <span class="profile-name">{{session.user.name}}</span>
              <svg class="chev" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
            </button>
            <ul class="profile-menu" id="profile-menu" role="menu" aria-label="Profile">
              <li role="none"><a role="menuitem" href="/profile">Profile</a></li>
              <li role="none"><a role="menuitem" href="/logout">Logout</a></li>
            </ul>
          </div>
        {{else}}
          <a class="btn" href="/login">Login</a>
        {{/if}}
      </div>
    </nav>
  </div>
</header>

<script>
  // small accessible toggles â€” safe to include inline inside partial
  (function () {
    const settingsBtn = document.getElementById('settings-btn');
    const settingsMenu = document.getElementById('settings-menu');
    if (settingsBtn && settingsMenu) {
      // Ensure menu is hidden by default - remove any open class
      settingsMenu.classList.remove('open');
      settingsBtn.setAttribute('aria-expanded', 'false');

      settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const isOpen = settingsMenu.classList.contains('open');
        if (isOpen) {
          // Close menu
          settingsMenu.classList.remove('open');
          settingsBtn.setAttribute('aria-expanded', 'false');
        } else {
          // Open menu
          settingsMenu.classList.add('open');
          settingsBtn.setAttribute('aria-expanded', 'true');
        }
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (settingsMenu && settingsBtn && !settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
          if (settingsMenu.classList.contains('open')) {
            settingsMenu.classList.remove('open');
            settingsBtn.setAttribute('aria-expanded', 'false');
          }
        }
      });

      // Close menu when pressing Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsMenu.classList.contains('open')) {
          settingsMenu.classList.remove('open');
          settingsBtn.setAttribute('aria-expanded', 'false');
        }
      });
    }

    const profileBtn = document.getElementById('profile-btn');
    const profileMenu = document.getElementById('profile-menu');
    if (profileBtn && profileMenu) {
      // Ensure menu is hidden by default - remove any open class
      profileMenu.classList.remove('open');
      profileBtn.setAttribute('aria-expanded', 'false');

      // Remove any Settings links from profile menu
      const settingsLinks = profileMenu.querySelectorAll('a[href="/settings"], a[href*="settings"]');
      settingsLinks.forEach(link => {
        const listItem = link.closest('li');
        if (listItem) {
          listItem.remove();
        }
      });

      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const isOpen = profileMenu.classList.contains('open');
        if (isOpen) {
          // Close menu
          profileMenu.classList.remove('open');
          profileBtn.setAttribute('aria-expanded', 'false');
        } else {
          // Open menu
          profileMenu.classList.add('open');
          profileBtn.setAttribute('aria-expanded', 'true');
        }
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (profileMenu && profileBtn && !profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
          if (profileMenu.classList.contains('open')) {
            profileMenu.classList.remove('open');
            profileBtn.setAttribute('aria-expanded', 'false');
          }
        }
      });

      // Close menu when pressing Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && profileMenu.classList.contains('open')) {
          profileMenu.classList.remove('open');
          profileBtn.setAttribute('aria-expanded', 'false');
        }
      });
    }
  })();
</script>
