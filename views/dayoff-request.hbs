<link rel="stylesheet" href="/requests.css">

<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 20px;
  }
  .form-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 30px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
  }
  .logo {
    font-size: 28px;
    font-weight: bold;
    color: #007bff;
  }
  .title {
    text-align: center;
    flex: 1;
  }
  .title h2, .title h3 {
    margin: 0;
    color: #333;
  }
  .employee-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    border-radius: 5px;
  }
  .employee-info div {
    display: flex;
    flex-direction: column;
  }
  .employee-info label {
    font-weight: bold;
    margin-bottom: 5px;
    color: #555;
  }
  .employee-info input, .employee-info div div {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .signature-line {
    border-bottom: 1px solid #000;
    width: 200px;
    margin-top: 20px;
  }
  .working-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    background: white;
  }
  .working-table th, .working-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: center;
  }
  .working-table th {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }
  .working-table tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  .working-table input, .working-table select {
    width: 100%;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .add-row-btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 20px;
  }
  .add-row-btn:hover {
    background-color: #218838;
  }
  .remaining-balance {
    margin-bottom: 30px;
    padding: 15px;
    background: #e9ecef;
    border-radius: 5px;
  }
  .remaining-balance label {
    font-weight: bold;
    margin-right: 10px;
  }
  .remaining-balance input {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .approval-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }
  .approval-block {
    padding: 20px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    border-radius: 5px;
  }
  .approval-block h4 {
    margin-top: 0;
    color: #007bff;
  }
  .approval-block div {
    margin-bottom: 15px;
  }
  .approval-block label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #555;
  }
  .approval-block input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .notes {
    background: #fff3cd;
    padding: 20px;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
  }
  .notes h4 {
    margin-top: 0;
    color: #856404;
  }
  .submit-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
  }
  .submit-btn:hover {
    background-color: #0056b3;
  }
</style>

<div class="form-container">
  <div class="header">
    <div class="logo">SRACO</div>
    <div class="title">
      <h2>King Abdullah Sports City</h2>
      <h3>Operation & Maintenance Facilities Management</h3>
      <h3>Leave in Lieu Request Form (LILRF)</h3>
    </div>
    <div class="logo">King Abdullah Sports City</div>
  </div>

  <div class="employee-info">
    <div>
      <label>Name of Requestor:</label>
      <input type="text" id="requestor-name" value="{{session.user.name}}" required>
    </div>
    <div>
      <label>Employee No.:</label>
      <input type="text" id="employee-no" value="{{session.user.employeeNo}}" required>
    </div>
    <div>
      <label>Signature:</label>
      <div class="signature-line">{{session.user.signature}}</div>
    </div>
    <div>
      <label>Date:</label>
      <input type="date" id="request-date" required>
    </div>
  </div>

  <table class="working-table">
    <thead>
      <tr>
        <th colspan="2">Working Day</th>
        <th colspan="2">Compensation Day (To Be Taken On)</th>
        <th>Remarks / Justification</th>
      </tr>
      <tr>
        <th>Date (dd/mm/yyyy)</th>
        <th>Day</th>
        <th>Date (dd/mm/yyyy)</th>
        <th>Day</th>
        <th>Remarks / Justification</th>
      </tr>
    </thead>
    <tbody id="working-days">
      <tr>
        <td><input type="date" class="working-date" required></td>
        <td>
          <select class="working-day" required>
            <option value="">Select Day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </td>
        <td><input type="date" class="compensation-date" required></td>
        <td>
          <select class="compensation-day" required>
            <option value="">Select Day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </td>
        <td><input type="text" class="remarks" placeholder="Enter remarks" required></td>
      </tr>
    </tbody>
  </table>

  <button type="button" id="add-row" class="btn btn-secondary">Add Another Day</button>

  <div class="remaining-balance">
    <label>Remaining Balance:</label>
    <input type="number" id="remaining-balance" value="13">
  </div>

  <div class="approval-section">
    <div class="approval-block">
      <h4>Supervisor Approval</h4>
      <div>
        <label>Reviewed by:</label>
        <input type="text" id="reviewed-by">
        <label>Date:</label>
        <input type="date" id="reviewed-date">
        <div class="signature-line"></div>
      </div>
      <div>
        <label>Supervisor:</label>
        <input type="text" id="supervisor">
        <label>Date:</label>
        <input type="date" id="supervisor-date">
        <div class="signature-line"></div>
      </div>
    </div>
    <div class="approval-block">
      <h4>Department Manager Approval</h4>
      <div>
        <label>Name:</label>
        <input type="text" id="manager-name">
        <label>Date:</label>
        <input type="date" id="manager-date">
        <div class="signature-line"></div>
      </div>
    </div>
  </div>

  <div class="notes">
    <h4>Mandatory Notes:</h4>
    <ul>
      <li>Managers' applications should be approved by Project Director only.</li>
      <li>Application must submit for approval at least 02 days prior to take day off.</li>
    </ul>
  </div>

  <button type="submit" class="btn btn-primary" id="submit-form">Submit Request</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('request-date').value = today;

  // Initialize remaining balance
  let remainingBalance = 13;
  document.getElementById('remaining-balance').value = remainingBalance;

  // Function to get day name from date
  function getDayName(dateString) {
    const date = new Date(dateString);
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[date.getDay()];
  }

  // Pre-fill form with query parameters
  const urlParams = new URLSearchParams(window.location.search);
  const selected = urlParams.get('selected');
  if (selected) {
    try {
      const selectedData = JSON.parse(selected);
      const tbody = document.getElementById('working-days');
      tbody.innerHTML = ''; // Clear existing rows
      selectedData.forEach(item => {
        const dayName = getDayName(item.date);
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td><input type="date" class="working-date" value="${item.date}" required></td>
          <td>
            <select class="working-day" required>
              <option value="">Select Day</option>
              <option value="Monday" ${dayName === 'Monday' ? 'selected' : ''}>Monday</option>
              <option value="Tuesday" ${dayName === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
              <option value="Wednesday" ${dayName === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
              <option value="Thursday" ${dayName === 'Thursday' ? 'selected' : ''}>Thursday</option>
              <option value="Friday" ${dayName === 'Friday' ? 'selected' : ''}>Friday</option>
              <option value="Saturday" ${dayName === 'Saturday' ? 'selected' : ''}>Saturday</option>
              <option value="Sunday" ${dayName === 'Sunday' ? 'selected' : ''}>Sunday</option>
            </select>
          </td>
          <td><input type="date" class="compensation-date" required></td>
          <td>
            <select class="compensation-day" required>
              <option value="">Select Day</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </select>
          </td>
          <td><input type="text" class="remarks" placeholder="Enter remarks" value="${item.remark}" required></td>
        `;
        tbody.appendChild(newRow);
      });
      // Update balance based on pre-filled rows
      remainingBalance = 13 - selectedData.length;
      document.getElementById('remaining-balance').value = remainingBalance;
    } catch (e) {
      console.error('Error parsing selected data:', e);
    }
  }

  const addRowBtn = document.getElementById('add-row');
  const workingDaysTbody = document.getElementById('working-days');
  const submitBtn = document.getElementById('submit-form');

  addRowBtn.onclick = function() {
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td><input type="date" class="working-date" required></td>
      <td>
        <select class="working-day" required>
          <option value="">Select Day</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
          <option value="Saturday">Saturday</option>
          <option value="Sunday">Sunday</option>
        </select>
      </td>
      <td><input type="date" class="compensation-date" required></td>
      <td>
        <select class="compensation-day" required>
          <option value="">Select Day</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
          <option value="Saturday">Saturday</option>
          <option value="Sunday">Sunday</option>
        </select>
      </td>
      <td><input type="text" class="remarks" placeholder="Enter remarks" required></td>
    `;
    workingDaysTbody.appendChild(newRow);
    // Update remaining balance
    remainingBalance -= 1;
    document.getElementById('remaining-balance').value = remainingBalance;
  };

  submitBtn.onclick = function(e) {
    e.preventDefault();
    // Collect form data and submit
    const formData = {
      requestorName: document.getElementById('requestor-name').value,
      employeeNo: document.getElementById('employee-no').value,
      requestDate: document.getElementById('request-date').value,
      workingDays: [],
      remainingBalance: document.getElementById('remaining-balance').value,
      reviewedBy: document.getElementById('reviewed-by').value,
      reviewedDate: document.getElementById('reviewed-date').value,
      supervisor: document.getElementById('supervisor').value,
      supervisorDate: document.getElementById('supervisor-date').value,
      managerName: document.getElementById('manager-name').value,
      managerDate: document.getElementById('manager-date').value
    };

    const rows = workingDaysTbody.querySelectorAll('tr');
    rows.forEach(row => {
      const workingDate = row.cells[0].querySelector('input').value;
      const workingDay = row.cells[1].querySelector('select').value;
      const compensationDate = row.cells[2].querySelector('input').value;
      const compensationDay = row.cells[3].querySelector('select').value;
      const remarks = row.cells[4].querySelector('input').value;
      formData.workingDays.push({
        workingDate: workingDate,
        workingDay: workingDay,
        compensationDate: compensationDate,
        compensationDay: compensationDay,
        remarks: remarks
      });
    });

    // Send to backend
    fetch('/requests/dayoff-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
      alert('Request submitted successfully!');
      window.close(); // Close the tab
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error submitting request');
    });
  };
});
</script>
