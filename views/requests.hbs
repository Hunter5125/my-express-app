<link rel="stylesheet" href="/requests.css">
<h1>Working Days</h1>
<button id="add-btn" class="btn btn-primary">Add Working Day</button>
<button id="request-btn" class="btn btn-secondary" style="margin-left: 10px;">Request DayOff</button>
<table class="requests-table" style="border-collapse: collapse; width: 100%;">
  <thead>
    <tr style="border-bottom: 2px solid #ddd;">
      <th style="border: 1px solid #ddd; padding: 8px;">Select</th>
      <th style="border: 1px solid #ddd; padding: 8px;">Working Day</th>
      <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
      <th style="border: 1px solid #ddd; padding: 8px;">Remark</th>
      <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
    </tr>
  </thead>
  <tbody>
    {{#each workingDays}}
    <tr data-id="{{this._id}}" style="border-bottom: 1px solid #ddd;">
      <td style="border: 1px solid #ddd; padding: 8px;"><input type="checkbox" class="select-checkbox" data-date="{{this.date}}" data-remark="{{this.remark}}"></td>
      <td style="border: 1px solid #ddd; padding: 8px;">{{this.day}}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">{{formatDate this.date}}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">{{this.remark}}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">
        <button class="btn btn-sm btn-warning edit-btn" style="margin-right: 5px;">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
      </td>
    </tr>
    {{/each}}
  </tbody>
  <tfoot>
    <tr style="border-top: 2px solid #ddd; font-weight: bold;">
      <td style="border: 1px solid #ddd; padding: 8px;" colspan="4">Total Working Days: {{workingDays.length}}</td>
    </tr>
  </tfoot>
</table>

<!-- Add/Edit Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 id="modal-title">Add New Request</h2>
    <form id="request-form">
      <input type="hidden" id="request-id">
      <label for="day">Working Day:</label>
      <select id="day" required>
        <option value="">Select Day</option>
        <option value="Sunday">Sunday</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
      </select>
      <label for="date">Date:</label>
      <input type="date" id="date" required>
      <label for="remark">Remark:</label>
      <input type="text" id="remark" required>
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('modal');
  const addBtn = document.getElementById('add-btn');
  const closeBtn = document.querySelector('.close');
  const form = document.getElementById('request-form');
  const modalTitle = document.getElementById('modal-title');

  const requestBtn = document.getElementById('request-btn');

  addBtn.onclick = function() {
    document.getElementById('request-id').value = '';
    document.getElementById('day').value = '';
    document.getElementById('date').value = '';
    document.getElementById('remark').value = '';
    modalTitle.textContent = 'Add New Working Day';
    modal.style.display = 'block';
  };



  requestBtn.onclick = function() {
    const selected = [];
    document.querySelectorAll('.select-checkbox:checked').forEach(cb => {
      selected.push({
        day: cb.dataset.day,
        date: cb.dataset.date,
        remark: cb.dataset.remark
      });
    });
    if (selected.length > 0) {
      const url = `/dayoff-request?selected=${encodeURIComponent(JSON.stringify(selected))}`;
      window.open(url, '_blank');
    } else {
      alert('Please select at least one day');
    }
  };

  closeBtn.onclick = function() {
    modal.style.display = 'none';
  };

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  };

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.onclick = function() {
      const row = this.closest('tr');
      const id = row.dataset.id;
      const cells = row.querySelectorAll('td');
      document.getElementById('request-id').value = id;
      document.getElementById('day').value = cells[1].textContent;
      document.getElementById('date').value = cells[2].textContent;
      document.getElementById('remark').value = cells[3].textContent;
      modalTitle.textContent = 'Edit Working Day';
      modal.style.display = 'block';
    };
  });

  function attachEventListeners() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = function() {
        const row = this.closest('tr');
        const id = row.dataset.id;
        const cells = row.querySelectorAll('td');
        document.getElementById('request-id').value = id;
        document.getElementById('day').value = cells[1].textContent;
        document.getElementById('date').value = cells[2].textContent;
        document.getElementById('remark').value = cells[3].textContent;
        modalTitle.textContent = 'Edit Working Day';
        modal.style.display = 'block';
      };
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = function() {
        if (confirm('Are you sure you want to delete this working day?')) {
          const row = this.closest('tr');
          const id = row.dataset.id;
          // Send delete request
          fetch('/requests/' + id, { method: 'DELETE' })
            .then(() => location.reload());
        }
      };
    });
  }

  attachEventListeners();



  form.onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById('request-id').value;
    const data = {
      day: document.getElementById('day').value,
      date: document.getElementById('date').value,
      remark: document.getElementById('remark').value
    };
    const method = id ? 'PUT' : 'POST';
    const url = id ? '/requests/' + id : '/requests';
    fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        return response.json().then(err => { throw new Error(err.error || 'Error saving working day'); });
      }
    })
    .then(data => {
      modal.style.display = 'none';
      // Always reload to show fresh data from database
      location.reload();
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
  };
});
</script>
