<link rel="stylesheet" href="/requests.css">
<h1>Working Days</h1>
<div class="table-wrapper">
<table class="requests-table">
  <thead>
    <tr>
      <th>Working Day</th>
      <th>Working Day Date</th>
      <th>Day to be taken</th>
      <th>Date to be taken</th>
      <th>Remark</th>
      <th>Remaining Balance</th>
      <th>Employee No</th>
      <th>Team Leader approval status</th>
      <th>Manager approval status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {{#each pendingRequests}}
    <tr data-request-id="{{this._id}}" data-working-day="{{#if this.workingDayIds.[0]}}{{this.workingDayIds.[0].day}}{{else if this.working_day}}{{this.working_day}}{{else}}N/A{{/if}}" data-working-date="{{#if this.workingDayIds.[0]}}{{#if this.workingDayIds.[0].date}}{{this.workingDayIds.[0].date}}{{/if}}{{else if this.working_day_date}}{{this.working_day_date}}{{/if}}" data-day-to-be-taken="{{#if this.day_to_be_taken}}{{this.day_to_be_taken}}{{else if this.day}}{{this.day}}{{else}}N/A{{/if}}" data-date-to-be-taken="{{#if this.date_to_be_taken}}{{this.date_to_be_taken}}{{else if this.date}}{{this.date}}{{else}}{{/if}}" data-remark="{{this.remark}}" data-balance="{{this.balance}}" data-employee-no="{{this.employee.employeeNo}}" data-team-leader-status="{{this.teamLeaderApprovalStatus}}" data-manager-status="{{this.managerApprovalStatus}}">
      <td data-label="Working Day">{{#if this.workingDayIds.[0]}}{{this.workingDayIds.[0].day}}{{else if this.working_day}}{{this.working_day}}{{else}}No Working Day{{/if}}</td>
      <td data-label="Working Day Date" data-raw-date="{{#if this.workingDayIds.[0]}}{{#if this.workingDayIds.[0].date}}{{this.workingDayIds.[0].date}}{{/if}}{{else if this.working_day_date}}{{this.working_day_date}}{{/if}}">{{#if this.workingDayIds.[0]}}{{#if this.workingDayIds.[0].date}}{{formatDate this.workingDayIds.[0].date}}{{else}}No Date{{/if}}{{else if this.working_day_date}}{{formatDate this.working_day_date}}{{else}}No Working Day{{/if}}</td>
      <td data-label="Day to Take">{{#if this.day_to_be_taken}}{{this.day_to_be_taken}}{{else if this.day}}{{this.day}}{{else}}N/A{{/if}}</td>
      <td data-label="Take Date" data-raw-compensation-date="{{#if this.date_to_be_taken}}{{this.date_to_be_taken}}{{else if this.date}}{{this.date}}{{else}}{{/if}}">{{#if this.date_to_be_taken}}{{formatDate this.date_to_be_taken}}{{else if this.date}}{{formatDate this.date}}{{else}}N/A{{/if}}</td>
      <td data-label="Remark">{{this.remark}}</td>
      <td data-label="Balance">{{balance}}</td>
      <td data-label="Emp No">{{this.employee.employeeNo}}</td>
      <td data-label="TL Status">{{this.teamLeaderApprovalStatus}}</td>
      <td data-label="Mgr Status">{{this.managerApprovalStatus}}</td>
      <td data-label="Actions">
        <button class="view-request-btn" data-id="{{this._id}}">üëÅÔ∏è</button>
        <button class="delete-request-btn" data-id="{{this._id}}">üóëÔ∏è</button>
      </td>
    </tr>
    {{/each}}
  </tbody>
</table>
</div>


<h2>Available Working Days</h2>
<button id="add-btn" class="btn btn-primary">Add Working Day</button>
<button id="request-btn" class="btn btn-secondary" style="margin-left: 10px;">Request DayOff</button>
<div class="table-wrapper">
<table class="requests-table working-days-table">
  <thead>
    <tr>
      <th>Working Day</th>
      <th>Date</th>
      <th>Remark</th>
      <th>Actions</th>
      <th>Balance</th>
    </tr>
  </thead>
  <tbody>
    {{#each workingDays}}
    <tr data-id="{{this._id}}" data-day="{{this.day}}" data-date="{{formatDate this.date 'iso'}}" data-remark="{{this.remark}}" data-balance="{{this.balance}}">
      <td data-label="Working Day">{{this.day}}</td>
      <td data-label="Date">{{formatDate this.date}}</td>
      <td data-label="Remark">{{this.remark}}</td>
      <td data-label="Actions">
        <button class="btn btn-sm btn-warning edit-btn" style="margin-right: 5px;">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
      </td>
      <td data-label="Balance">{{this.balance}}</td>
    </tr>
    {{/each}}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4">Total Working Days: {{workingDays.length}}</td>
      <td>Balance: {{balance}}</td>
    </tr>
  </tfoot>
</table>
</div>

<!-- Add/Edit Working Day Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Add New Working Day</h2>
      <button type="button" class="modal-close" id="close-btn">&times;</button>
    </div>
    <form id="request-form">
      <input type="hidden" id="request-id">
      
      <div class="form-row">
        <div class="form-item">
          <label for="day">Working Day:</label>
          <select id="day" required>
            <option value="">Select Day</option>
            <option value="Sunday">Sunday</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
          </select>
        </div>
        <div class="form-item">
          <label for="date">Working Date:</label>
          <input type="date" id="date" required>
        </div>
      </div>

      <label for="remark">Remark:</label>
      <input type="text" id="remark" required>
      
      <label for="balance">Balance:</label>
      <input type="number" id="balance" step="0.5" min="0" required>
      
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
  </div>
</div>

<!-- Request DayOff Days Selection Modal -->
<div id="days-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Request Day Off</h2>
      <button type="button" class="modal-close" id="days-close-btn">&times;</button>
    </div>
    <div style="padding: 2rem;">
      <label for="days-input" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #0f172a;">How many days do you want to take?</label>
      <input type="number" id="days-input" step="0.5" min="0.5" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem;">
      <p id="days-warning" style="color: #ef4444; font-weight: 500; margin-bottom: 1rem; display: none;"></p>
      <div style="display: flex; gap: 1rem;">
        <button id="days-submit-btn" type="button" class="btn btn-primary" style="flex: 1;">Request Days</button>
        <button id="days-cancel-btn" type="button" class="btn btn-secondary" style="flex: 1; background-color: #6b7280;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('modal');
  const addBtn = document.getElementById('add-btn');
  const closeBtn = document.getElementById('close-btn');
  const form = document.getElementById('request-form');
  const modalTitle = document.getElementById('modal-title');
  const requestBtn = document.getElementById('request-btn');
  
  // Store working days data from server - THIS is the source of truth
  const workingDaysData = {{{json workingDays}}};
  console.log('‚úÖ Working Days Data:', workingDaysData);
  if (workingDaysData && Array.isArray(workingDaysData)) {
    workingDaysData.forEach((wd, idx) => {
      console.log(`   [${idx}] day="${wd.day}" date="${wd.date}" remark="${wd.remark}" balance=${wd.balance}`);
    });
  }
  
  const balance = {{balance}};
  console.log('üí∞ Total available balance:', balance);

  // Modal toggle functions
  function openModal() {
    modal.style.display = 'flex';
  }

  function closeModal() {
    modal.style.display = 'none';
  }

  // Add Working Day button
  addBtn.onclick = function() {
    document.getElementById('request-id').value = '';
    document.getElementById('day').value = '';
    document.getElementById('date').value = '';
    document.getElementById('remark').value = '';
    document.getElementById('balance').value = '';
    modalTitle.textContent = 'Add New Working Day';
    openModal();
  };

  // Close button on modal
  closeBtn.onclick = function() {
    closeModal();
  };

  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target === modal) {
      closeModal();
    }
    if (event.target === daysModal) {
      daysModal.style.display = 'none';
    }
  };

  // Days modal elements
  const daysModal = document.getElementById('days-modal');
  const daysCloseBtn = document.getElementById('days-close-btn');
  const daysInput = document.getElementById('days-input');
  const daysSubmitBtn = document.getElementById('days-submit-btn');
  const daysCancelBtn = document.getElementById('days-cancel-btn');
  const daysWarning = document.getElementById('days-warning');

  // Request Day Off button - show days modal
  requestBtn.onclick = function() {
    daysInput.value = '';
    daysWarning.style.display = 'none';
    daysModal.style.display = 'flex';
  };

  // Close days modal
  daysCloseBtn.onclick = function() {
    daysModal.style.display = 'none';
  };

  daysCancelBtn.onclick = function() {
    daysModal.style.display = 'none';
  };

  // Submit days request
  daysSubmitBtn.onclick = function() {
    const daysRequested = parseFloat(daysInput.value);
    
    if (isNaN(daysRequested) || daysRequested <= 0) {
      daysWarning.textContent = 'Please enter a valid number of days.';
      daysWarning.style.display = 'block';
      return;
    }

    if (daysRequested > balance) {
      daysWarning.textContent = `You only have ${balance} days available. Cannot request ${daysRequested} days.`;
      daysWarning.style.display = 'block';
      return;
    }

    // Calculate which working days to use
    const selectedDays = calculateDaysToTake(daysRequested);
    
    if (selectedDays.length === 0) {
      daysWarning.textContent = 'Not enough working days available for the requested number of days.';
      daysWarning.style.display = 'block';
      return;
    }

    // Create request with selected days
    createDayOffRequest(selectedDays, daysRequested);
  };

  // Calculate which days to take (from last/newest to oldest)
  function calculateDaysToTake(daysRequested) {
    console.log('\nüîÑ calculateDaysToTake called with:', daysRequested, 'days');
    
    // Use the server-provided data instead of reading from table
    if (!workingDaysData || !Array.isArray(workingDaysData) || workingDaysData.length === 0) {
      console.error('‚ùå No working days data available!');
      alert('No working days available');
      return [];
    }
    
    console.log(`üìä Using ${workingDaysData.length} working days from server data`);
    workingDaysData.forEach((wd, idx) => {
      console.log(`   [${idx}] day="${wd.day}" date="${wd.date}" remark="${wd.remark}" balance=${wd.balance}`);
    });
    
    const selectedDays = [];
    let daysRemaining = daysRequested;

    // Strategy 1: Try to find a SINGLE day that can fulfill the entire request
    console.log(`\nüìã Strategy 1: Looking for a single day with >= ${daysRequested} days...`);
    for (let i = 0; i < workingDaysData.length; i++) {
      const wd = workingDaysData[i];
      const dayBalance = parseFloat(wd.balance);
      
      if (!wd.day || !wd.date) {
        console.warn(`  ‚ö†Ô∏è  Row ${i}: Missing day or date!`, wd);
        continue;
      }
      
      console.log(`  [${i}] day="${wd.day}" date="${wd.date}" remark="${wd.remark}" balance=${dayBalance}`);
      
      // Skip days with no balance
      if (dayBalance <= 0) {
        console.log(`      ‚Üí Skipped (balance <= 0)`);
        continue;
      }
      
      // If this day has enough to cover the entire request, use only this day
      if (dayBalance >= daysRequested) {
        console.log(`  ‚úÖ Found! Using day ${i} with ${daysRequested} days`);
        selectedDays.push({
          id: wd._id,
          day: wd.day,
          date: wd.date,
          remark: wd.remark,
          daysUsed: daysRequested,
          balanceRemaining: dayBalance - daysRequested
        });
        return selectedDays;  // Return immediately
      }
    }

    // Strategy 2: If no single day can cover it, use FIFO
    console.log(`\nüìã Strategy 2: No single day found, using FIFO...`);
    daysRemaining = daysRequested;
    
    for (let i = 0; i < workingDaysData.length && daysRemaining > 0; i++) {
      const wd = workingDaysData[i];
      const dayBalance = parseFloat(wd.balance);

      if (!wd.day || !wd.date) {
        console.warn(`  ‚ö†Ô∏è  Row ${i}: Missing day or date!`, wd);
        continue;
      }

      console.log(`  [${i}] day="${wd.day}" balance=${dayBalance} need=${daysRemaining}`);

      if (dayBalance <= 0) {
        console.log(`      ‚Üí Skipped (balance <= 0)`);
        continue;
      }

      if (dayBalance >= daysRemaining) {
        console.log(`      ‚úÖ Using ${daysRemaining} from this day`);
        selectedDays.push({
          id: wd._id,
          day: wd.day,
          date: wd.date,
          remark: wd.remark,
          daysUsed: daysRemaining,
          balanceRemaining: dayBalance - daysRemaining
        });
        daysRemaining = 0;
      } else {
        console.log(`      ‚úÖ Using all ${dayBalance} from this day`);
        selectedDays.push({
          id: wd._id,
          day: wd.day,
          date: wd.date,
          remark: wd.remark,
          daysUsed: dayBalance,
          balanceRemaining: 0
        });
        daysRemaining -= dayBalance;
      }
    }

    console.log('‚úÖ Final selectedDays:', selectedDays);
    return selectedDays;
  }

  // Create day off request with calculated days
  function createDayOffRequest(selectedDays, totalDaysRequested) {
    const currentAvailableBalance = balance;

    console.log('‚úÖ createDayOffRequest called with:', selectedDays);

    // Sort selected days by date (oldest first)
    const sortedSelectedDays = selectedDays.slice().sort((a, b) => {
      const dateA = new Date(a.date).getTime();
      const dateB = new Date(b.date).getTime();
      return dateA - dateB;
    });

    // Build the request data - ENSURE ALL FIELDS ARE PRESENT
    const requestData = {
      selected: sortedSelectedDays.map((d, idx) => {
        console.log(`  Item ${idx} building:`, {original: d, extracted: {day: d.day, date: d.date, remark: d.remark}});
        return {
          day: d.day || '',
          date: d.date || '',
          remark: d.remark || '',
          id: d.id || '',
          balance: d.daysUsed  
        };
      }),
      remainingBalance: currentAvailableBalance
    };

    console.log('üì§ Data to send:', JSON.stringify(requestData.selected));
    
    // Validate
    const hasAllFields = requestData.selected.every((item, idx) => {
      const hasDay = item.day && item.day.trim().length > 0;
      const hasDate = item.date && item.date.trim().length > 0;
      if (!hasDay) console.error(`‚ùå Item ${idx} missing day:`, item);
      if (!hasDate) console.error(`‚ùå Item ${idx} missing date:`, item);
      return hasDay && hasDate;
    });
    
    if (!hasAllFields) {
      console.warn('‚ö†Ô∏è  Some items missing day or date - form may not populate correctly');
    }

    const encodedData = encodeURIComponent(JSON.stringify(requestData.selected));
    const finalUrl = `/requests/dayoff-request?selected=${encodedData}&balance=${currentAvailableBalance}&totalDaysRequested=${totalDaysRequested}`;
    
    console.log('üîó Final URL:', finalUrl);
    window.location.href = finalUrl;
  }

  // Edit button handler
  function attachEditBtnListeners() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = function(e) {
        e.stopPropagation();
        const row = this.closest('tr');
        const id = row.dataset.id;
        
        // Get data directly from dataset attributes (more reliable)
        const day = row.dataset.day;
        const date = row.dataset.date;
        const remark = row.dataset.remark;
        const balance = row.dataset.balance;
        
        // Populate form with data
        document.getElementById('request-id').value = id;
        document.getElementById('day').value = day;
        
        // Format date to YYYY-MM-DD for input[type=date]
        const dateValue = date ? new Date(date).toISOString().split('T')[0] : '';
        document.getElementById('date').value = dateValue;
        
        document.getElementById('remark').value = remark;
        document.getElementById('balance').value = balance;
        
        document.getElementById('modal-title').textContent = 'Edit Working Day';
        openModal();
      };
    });
  }

  // Delete button handler for working days
  function attachDeleteBtnListeners() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = function(e) {
        e.stopPropagation();
        if (confirm('Are you sure you want to delete this working day?')) {
          const row = this.closest('tr');
          const id = row.dataset.id;
          fetch('/requests/' + id, { method: 'DELETE' })
            .then(response => {
              if (response.ok) {
                location.reload();
              } else {
                alert('Error deleting working day');
              }
            });
        }
      };
    });
  }

  // View request button handler
  function attachViewRequestBtnListeners() {
    document.querySelectorAll('.view-request-btn').forEach(btn => {
      btn.onclick = function(e) {
        e.stopPropagation();
        // Open the server-rendered view using requestId for reliable population
        const requestId = this.dataset.id;
        if (requestId) {
          window.open(`/requests/dayoff-request?requestId=${requestId}`, '_blank');
        }
      };
    });
  }

  // Delete request button handler
  function attachDeleteRequestBtnListeners() {
    document.querySelectorAll('.delete-request-btn').forEach(btn => {
      btn.onclick = function(e) {
        e.stopPropagation();
        if (confirm('Are you sure you want to delete this request?')) {
          const id = this.dataset.id;
          fetch('/requests/request/' + id, { method: 'DELETE' })
            .then(response => {
              if (response.ok) {
                location.reload();
              } else {
                alert('Error deleting request');
              }
            });
        }
      };
    });
  }

  // Form submit handler
  form.onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById('request-id').value;
    const data = {
      day: document.getElementById('day').value,
      date: document.getElementById('date').value,
      remark: document.getElementById('remark').value,
      balance: document.getElementById('balance').value
    };
    const method = id ? 'PUT' : 'POST';
    const url = id ? '/requests/' + id : '/requests';
    fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        return response.json().then(err => { throw new Error(err.error || 'Error saving working day'); });
      }
    })
    .then(data => {
      closeModal();
      location.reload();
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
  };

  // Attach all listeners on page load
  attachEditBtnListeners();
  attachDeleteBtnListeners();
  attachViewRequestBtnListeners();
  attachDeleteRequestBtnListeners();
});
</script>
